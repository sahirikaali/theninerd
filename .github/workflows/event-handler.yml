name: Event Handler

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'event_handler/**'
      - '.github/workflows/event-handler.yml'

concurrency:
  group: event-handler
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
      actions: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        working-directory: event_handler
        run: npm ci

      - name: Start Cloudflare Tunnel
        run: |
          # Install cloudflared
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
          
          # Start tunnel in background, log to file
          cloudflared tunnel --url http://localhost:3000 --no-autoupdate > /tmp/cloudflared.log 2>&1 &
          
          # Wait for tunnel URL to appear (60 second timeout: 30 attempts Ã— 2 seconds)
          echo "Waiting for Cloudflare Tunnel URL..."
          for i in $(seq 1 30); do
            FUNNEL_URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/cloudflared.log | head -1)
            if [ -n "$FUNNEL_URL" ]; then
              break
            fi
            sleep 2
          done
          
          if [ -z "$FUNNEL_URL" ]; then
            echo "Failed to get Cloudflare Tunnel URL"
            cat /tmp/cloudflared.log
            exit 1
          fi
          
          echo "Tunnel URL: $FUNNEL_URL"
          echo "FUNNEL_URL=$FUNNEL_URL" >> $GITHUB_ENV

      - name: Update GH_WEBHOOK_URL variable
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh variable set GH_WEBHOOK_URL --body "$FUNNEL_URL" --repo ${{ github.repository }}

      - name: Build .env from secrets
        working-directory: event_handler
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Derive deterministic secrets from GH_PAT (consistent across workflows)
          API_KEY=$(echo -n "api-key:${GH_PAT}" | sha256sum | cut -d' ' -f1)
          GH_WEBHOOK_SECRET=$(echo -n "gh-webhook:${GH_PAT}" | sha256sum | cut -d' ' -f1)
          TELEGRAM_WEBHOOK_SECRET=$(echo -n "tg-webhook:${GH_PAT}" | sha256sum | cut -d' ' -f1)
          
          # Extract owner/repo from github.repository
          GH_OWNER="${{ github.repository_owner }}"
          GH_REPO=$(echo "${{ github.repository }}" | cut -d/ -f2)
          
          # Build .env file
          cat > .env << EOF
          API_KEY=${API_KEY}
          GH_TOKEN=${GH_PAT}
          GH_OWNER=${GH_OWNER}
          GH_REPO=${GH_REPO}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          GH_WEBHOOK_SECRET=${GH_WEBHOOK_SECRET}
          NVIDIA_API_KEY=${NVIDIA_API_KEY}
          EOF
          
          echo ".env built from flat secrets"

      - name: Run event handler
        working-directory: event_handler
        run: |
          # Start server in background
          node server.js &
          SERVER_PID=$!
          
          # Ensure cleanup on exit
          trap 'kill $SERVER_PID 2>/dev/null || true' EXIT
          
          # Wait for server to be ready
          sleep 5
          
          # Register Telegram webhook (if bot token is configured)
          if grep -q "^TELEGRAM_BOT_TOKEN=[^[:space:]]" .env 2>/dev/null; then
            BOT_TOKEN=$(grep "^TELEGRAM_BOT_TOKEN=" .env | cut -d= -f2-)
            TG_WEBHOOK_SECRET=$(grep "^TELEGRAM_WEBHOOK_SECRET=" .env | cut -d= -f2-)
            WEBHOOK_URL="${FUNNEL_URL}/telegram/webhook"
            
            echo "Registering Telegram webhook: $WEBHOOK_URL"
            
            # Delete existing webhook first (Telegram ignores secret_token changes if URL unchanged)
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/deleteWebhook" > /dev/null
            
            # Set new webhook with secret
            RESULT=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook" \
              -H "Content-Type: application/json" \
              -d "{\"url\": \"${WEBHOOK_URL}\", \"secret_token\": \"${TG_WEBHOOK_SECRET}\"}")
            
            echo "Telegram webhook registration: $RESULT"
          else
            echo "No TELEGRAM_BOT_TOKEN configured, skipping webhook registration"
          fi
          
          # Wait for timeout (5h 45m) then stop
          sleep 20700 || true

      - name: Re-trigger workflow
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh workflow run event-handler.yml --repo ${{ github.repository }}
